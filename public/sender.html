<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Feed remoto (emisor)</title>
<style>
  body {
    background: #0d1117;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 20px;
  }
  video {
    width: 80%;
    border-radius: 10px;
    margin-top: 10px;
  }
  button {
    background: #238636;
    border: none;
    color: #fff;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.2s ease;
  }
  button:hover { background: #2ea043; }
</style>
</head>
<body>
  <h2>üì° Enviar mi c√°mara a la PC receptora</h2>
  <video id="localVideo" autoplay muted playsinline></video>
  <div style="display:flex; gap:8px;">
    <button id="startBtn">Iniciar y compartir c√°mara</button>
    <button id="stopBtn" disabled>Detener</button>
  </div>
  <p id="log" style="color:#ddd;"></p>

<script>
const protocol = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(protocol + "thefindoraprototipe.onrender.com" + "/ws");


const senderId = Math.random().toString(36).slice(2, 9);
let pc = null;
let localStream = null;

ws.onopen = () => console.log("WebSocket conectado");

function log(msg) {
    console.log(msg);
    document.getElementById("log").textContent = msg;
}

document.getElementById("startBtn").onclick = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({
    video: { width: 640, height: 480, frameRate: { ideal: 30 } },
    audio: false
});

const video = document.getElementById("localVideo");
video.srcObject = localStream;

video.onloadedmetadata = () => {
    video.play().catch(err => console.error("Error reproduciendo c√°mara local:", err));
};


        pc = new RTCPeerConnection({
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
      urls: "turn:relay.metered.ca:80",
      username: "openai",
      credential: "openai"
    }
    ]
});


        pc.onicecandidate = (e) => {
    if (e.candidate) {
        ws.send(JSON.stringify({
            type: "ice",
            from: senderId,
            to: "receiver",
            ice: {
                candidate: e.candidate.candidate,
                sdpMid: e.candidate.sdpMid,
                sdpMLineIndex: e.candidate.sdpMLineIndex
            }
        }));
    }
};


        for (const track of localStream.getTracks()) {
            pc.addTrack(track, localStream);
        }

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        ws.send(JSON.stringify({
            type: "offer",
            from: senderId,
            offer: { type: offer.type, sdp: offer.sdp }
        }));

        log("Offer enviada. Esperando answer...");
        startBtn.disabled = true;
        stopBtn.disabled = false;

    } catch (err) {
        alert("Error accediendo a la c√°mara: " + err.message);
    }
};

document.getElementById("stopBtn").onclick = () => {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (pc) pc.close();
    pc = null;
    localStream = null;
    log("Compartici√≥n detenida");
    startBtn.disabled = false;
    stopBtn.disabled = true;
};

ws.onmessage = async (event) => {
    let text;

    if (event.data instanceof Blob) {
        text = await event.data.text();
    } else if (event.data instanceof ArrayBuffer) {
        text = new TextDecoder().decode(event.data);
    } else {
        text = event.data;
    }

    let data;
    try {
        data = JSON.parse(text);
    } catch (err) {
        console.error("‚ùå Mensaje recibido NO es JSON:", text);
        return;
    }

    if (data.type === "answer" && data.to === senderId) {
        if (!pc) return;
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        log("Answer recibida. Conexi√≥n establecida.");
    }

    if (data.type === "ice" && data.to === senderId && pc) {
        await pc.addIceCandidate(new RTCIceCandidate(data.ice));
    }
};

</script>
</body>
</html>
